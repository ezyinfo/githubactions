name: Deploy HTML and Test

on:
    push:
        branches:
            - main

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
        - name: Checkout repo
          uses: actions/checkout@v4

        # Déploiement via GitHub Pages
        - name: Setup Pages
          uses: actions/configure-pages@v5

        - name: Upload artifact
          uses: actions/upload-pages-artifact@v3
          with:
            path: .

    deploy:
        needs: build
        runs-on: ubuntu-latest

        permissions:
            pages: write
            id-token: write

        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}

        outputs:
            page_url: ${{ steps.deployment.outputs.page_url }}

        steps:
            - name: Deploy
              id: deployment
              uses: actions/deploy-pages@v4

    test:
        runs-on: ubuntu-latest
        needs: deploy

        steps:
            - name : Tester mon appli
              env:
                BASE_URL: ${{ needs.deploy.outputs.page_url }}
              run: |
                    sleep 10 # attendre un peu le déploiement
                    RESPONSE=$(curl -s "${BASE_URL}" | tr -d '\n' | xargs)
                    if [ "$RESPONSE" != "OK" ]; then
                        echo "La page ne renvoie pas OK mais: $RESPONSE"
                        exit 1
                    fi
                    echo "Page OK ✅"

